# Memory monitoring configuration for RSR
# Adds django-prometheus and custom RSR memory monitoring capabilities

# Enable Prometheus metrics collection
# Note: Metrics are available via Django URL /metrics/ instead of separate port
# PROMETHEUS_METRICS_EXPORT_PORT = 8001
# PROMETHEUS_METRICS_EXPORT_ADDRESS = ''

# RSR Memory Monitoring Configuration
RSR_MEMORY_MONITORING_ENABLED = True
RSR_MEMORY_DETAILED_TRACKING = False  # Enable for development/debugging only
RSR_MEMORY_HEADER_PREFIX = 'X-RSR-Memory'
RSR_METRICS_UPDATE_INTERVAL = 300  # 5 minutes
RSR_MEMORY_HIGH_USAGE_THRESHOLD_MB = 50.0

# Cache metrics configuration
RSR_CACHE_METRICS_ENABLED = True
RSR_CACHE_METRICS_FREQUENCY = 60  # 1 minute

# Enhanced leak detection configuration
RSR_LEAK_DETECTION_ENABLED = True
RSR_LEAK_CHECK_INTERVAL = 300  # 5 minutes
RSR_LEAK_GROWTH_THRESHOLD = 1.5  # 50% growth triggers leak indicator
RSR_LEAK_MEMORY_THRESHOLD_MB = 100.0  # Memory threshold for leak detection

# Deep memory profiling with memray
RSR_PROFILING_ENABLED = False  # Enable only when needed for debugging
RSR_PROFILING_OUTPUT_DIR = '/tmp/rsr_profiling'  # Directory for profile files
RSR_MAX_PROFILE_SIZE_MB = 100  # Maximum profile file size warning threshold
RSR_PROFILING_CLEANUP_DAYS = 7  # Days to keep profile files before cleanup

# Add prometheus and memory monitoring middleware
if 'django_prometheus.middleware.PrometheusBeforeMiddleware' not in MIDDLEWARE:
    MIDDLEWARE = ['django_prometheus.middleware.PrometheusBeforeMiddleware'] + list(MIDDLEWARE)

# Add RSR memory monitoring middleware after prometheus
if 'akvo.rsr.memory_monitoring.middleware.RSRMemoryMonitoringMiddleware' not in MIDDLEWARE:
    middleware_list = list(MIDDLEWARE)
    prometheus_index = middleware_list.index('django_prometheus.middleware.PrometheusBeforeMiddleware')
    middleware_list.insert(prometheus_index + 1, 'akvo.rsr.memory_monitoring.middleware.RSRMemoryMonitoringMiddleware')
    MIDDLEWARE = middleware_list

# Add prometheus after middleware at the end
if 'django_prometheus.middleware.PrometheusAfterMiddleware' not in MIDDLEWARE:
    MIDDLEWARE = list(MIDDLEWARE) + ['django_prometheus.middleware.PrometheusAfterMiddleware']

# Add prometheus to installed apps
if 'django_prometheus' not in INSTALLED_APPS:
    INSTALLED_APPS = list(INSTALLED_APPS) + ['django_prometheus']

# Configure database metrics (optional)
# DATABASES['default']['ENGINE'] = 'django_prometheus.db.backends.postgresql'

# Logging configuration for memory monitoring is added in 90-finish.conf