During development, we noticed that the production DB schema is quite different from the schema generated from an empty DB. For example, the production DB contains some tables that no longer are in use.

This script generates a SQL script to sync the production schema with the schema generated by running all the existing migrations on an empty DB.

It also adds some data cleaning SQL statements to be able to apply the new foreign keys and uniqueness constraints.

This script requires two files:

1. **prod.schema**: schema dump from production. Use the dump-schema.sh script to generate one either from production directly, from test or after restoring a production dump into your local environment

1. **clean.schema**: schema dump after applying migrations from an empty DB. This requires a bunch of manual steps to configure your dev environment:

   1. in postgres/setup.sh, comment out the line that executes restore-from-dump.sh
   1. in postgres/setup.sh, comment out the line that executes helpers/init.sql
   1. in akvo/urls.py, comment out all of the if settings.REQUIRED_AUTH_GROUPS 
   1. in scripts/docker/dev/start-django.sh, comment out the line that executes wait-for-dependencies .sh
   1. Do a docker-compose down+up
   1. The "web" container will probably fail because the DB is not yet ready when starting, so wait a few seconds and restart the web container.
   1. You should see a lot of migrations run by the web container now.
   1. Use the dump-schema.sh script once all the migrations are run.

Once both those files are generated, to run this script:

    docker run -it --rm -v `pwd`:/usr/src/app -w /usr/src/app clojure:openjdk-11-lein-2.9.1
    
Then on the REPL run:

    (require 'parse_pg_dump :reload)
    
If everything works, a file called `migration-script.sql` should be created. See `apply-new-schema.sh` about how to apply changes using a **single transaction**.
    
Note that this is not a generic solution, but one that works for the current prod vs dev schemas. The script has some guards in some unexpected/unsupported data is found. 

Use with extreme care.